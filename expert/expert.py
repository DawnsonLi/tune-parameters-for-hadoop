# -*- coding: utf-8 -*-
"""
Created on Mon Jul 31 15:38:03 2017
@author: dawnson

æ„å»ºåŸºæœ¬çš„å‚æ•°è®¾ç½®è§„åˆ™ï¼Œå»ºç«‹ä¸“å®¶ç³»ç»Ÿçš„çŸ¥è¯†åº“
åŠŸèƒ½ï¼šå¯¹å·²ç»è¿è¡Œå®Œæˆä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå¯¹å…¶å‚æ•°è¿›è¡Œè°ƒæ•?"""

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?io.sort.mb
@è¯´æ˜ï¼?æ¯ä¸€ä¸ªmapéƒ½ä¼šå¯¹åº”å­˜åœ¨ä¸€ä¸ªå†…å­˜bufferï¼ˆMapOutputBufferï¼‰ï¼Œmapä¼šå°†å·²ç»äº§ç”Ÿçš„éƒ¨åˆ†ç»“æœå…ˆå†™å…¥åˆ°è¯¥bufferä¸­ï¼Œè¿™ä¸ªbufferé»˜è®¤æ˜?00MBå¤§å°ï¼?map taskå¯¹ç£ç›˜çš„æ“ä½œå°±ä¼šå˜å°‘ï¼Œå¦‚æœmap tasksçš„ç“¶é¢ˆåœ¨ç£ç›˜ä¸Šï¼Œè¿™æ ·è°ƒæ•´å°±ä¼šå¤§å¤§æé«˜mapçš„è®¡ç®—æ€§èƒ½ã€?@è°ƒæ•´ç­–ç•¥ï¼?è®¡ç®—å†å²ä»»åŠ¡ä¸­ï¼šæ¯ä¸ªmapä»»åŠ¡çš„å¹³å‡æ•°æ®æº¢å‡ºå¤§å°ä¸ºï¼šmapè¿‡ç¨‹spillçš„è®°å½•ä¸ªæ•?è®°å½•å­—èŠ‚å¤§å°/mapä¸ªæ•°ï¼Œå³ä¸ºè°ƒæ•´é‡
@å‡½æ•°è¾“å…¥è¯´æ˜ï¼?map_num:mapä»»åŠ¡çš„ä¸ªæ•?spill_records:å‘ç”Ÿæº¢å‡ºçš„è®°å½•ä¸ªæ•?recordsize:æ¯æ¡è®°å½•çš„å­—èŠ‚å¤§å°?d:å†å²ä»»åŠ¡é…ç½®å‚æ•°æ„æˆçš„å­—å…?æ³¨ï¼šè¿™é‡Œçš„recordsizeç”±mapoutputçš„å­—èŠ‚æ•°å’Œè®°å½•æ•°è®¡ç®—
'''
def getIOSortMb(map_num, spill_records, recordsize, d):
    sortmb = float(d['mapreduce.task.io.sort.mb'])
    avgspillsize = spill_records * recordsize * 1.0 / map_num
    o = sortmb + avgspillsize
    if o > 1200:
	return 1200
    return o

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?io.sort.factor
@è¯´æ˜ï¼?è¯¥å‚æ•°é»˜è®¤ä¸º10ã€‚å®ƒè¡¨ç¤ºå½“merge spillæ–‡ä»¶æ—¶ï¼Œæœ€å¤šèƒ½æœ‰å¤šå°‘å¹¶è¡Œçš„streamå‘mergeæ–‡ä»¶ä¸­å†™å…¥ã€?å½“mapçš„ä¸­é—´ç»“æœéå¸¸å¤§ï¼Œè°ƒå¤§io.sort.factorï¼Œæœ‰åˆ©äºå‡å°‘mergeæ¬¡æ•°ï¼Œè¿›è€Œå‡å°‘mapå¯¹ç£ç›˜çš„è¯»å†™é¢‘ç‡
@å‡½æ•°å‚æ•°è¯´æ˜ï¼šmapè¾“å‡ºçš„å­—èŠ‚å¤§å°ï¼Œå’Œé˜ˆå€¼ï¼Œé»˜è®¤10G,dä¸ºå‚æ•°å­—å…?'''
def getSortFactor(mapOutputBytes, d ):
    threshold=10000000
    if mapOutputBytes > threshold:
      return int(d['mapreduce.task.io.sort.factor'])+1
    else:
        return d['mapreduce.task.io.sort.factor']

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?mapred.compress.map.output
@è¯´æ˜ï¼?å‹ç¼©çš„å¥½å¤„åœ¨äºï¼Œé€šè¿‡å‹ç¼©å‡å°‘å†™å…¥è¯»å‡ºç£ç›˜çš„æ•°æ®é‡ã€‚å¯¹ä¸­é—´ç»“æœéå¸¸å¤§ï¼Œç£ç›˜é€Ÿåº¦æˆä¸ºmapæ‰§è¡Œç“¶é¢ˆçš„jobï¼Œå°¤å…¶æœ‰ç”?@å‡½æ•°å‚æ•°è¯´æ˜ï¼šmapè¾“å‡ºçš„å­—èŠ‚å¤§å°ï¼Œå’Œé˜ˆå€¼ï¼Œé»˜è®¤1G
'''
def Compress(mapOutputBytes, d, threshold=10000000):
    if mapOutputBytes > threshold:
        return True
    else:
        return d['mapred.compress.map.output']

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?mapä¸ªæ•°
@è¯´æ˜ï¼?mapçš„æ•°é‡é€šå¸¸æ˜¯ç”±hadoopé›†ç¾¤çš„DFSå—å¤§å°ç¡®å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥æ–‡ä»¶çš„æ€»å—æ•°ï¼Œ
æ­£å¸¸çš„mapæ•°é‡çš„å¹¶è¡Œè§„æ¨¡å¤§è‡´æ˜¯æ¯ä¸€ä¸ªNodeæ˜?0~100ä¸ªï¼Œå¯¹äºCPUæ¶ˆè€—è¾ƒå°çš„ä½œä¸šå¯ä»¥è®¾ç½®Mapæ•°é‡ä¸?00ä¸ªå·¦å³ï¼Œ
ä½†æ˜¯ç”±äºhadoopçš„æ²¡ä¸€ä¸ªä»»åŠ¡åœ¨åˆå§‹åŒ–æ—¶éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œå› æ­¤æ¯”è¾ƒåˆç†çš„æƒ…å†µæ˜¯æ¯ä¸ªmapæ‰§è¡Œçš„æ—¶é—´è‡³å°‘è¶…è¿?åˆ†é’Ÿã€?å…·ä½“çš„æ•°æ®åˆ†ç‰‡æ˜¯è¿™æ ·çš„ï¼ŒInputFormatåœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæ ¹æ®hadoopé›†ç¾¤çš„DFSå—å¤§å°è¿›è¡Œåˆ†ç‰‡ï¼Œæ¯ä¸€ä¸ªåˆ†ç‰‡ä¼šç”±ä¸€ä¸ªmapä»»åŠ¡æ¥è¿›è¡Œå¤„ç†ï¼Œ
å½“ç„¶ç”¨æˆ·è¿˜æ˜¯å¯ä»¥é€šè¿‡å‚æ•°mapred.min.split.sizeå‚æ•°åœ¨ä½œä¸šæäº¤å®¢æˆ·ç«¯è¿›è¡Œè‡ªå®šä¹‰è®¾ç½®ã€?è¿˜æœ‰ä¸€ä¸ªé‡è¦å‚æ•°å°±æ˜¯mapred.map.tasksï¼Œè¿™ä¸ªå‚æ•°è®¾ç½®çš„mapæ•°é‡ä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œ
åªæœ‰å½“InputFormatå†³å®šäº†mapä»»åŠ¡çš„ä¸ªæ•°æ¯”mapred.map.taskså€¼å°æ—¶æ‰èµ·ä½œç”¨ã€?å½“ç”¨æˆ·çš„mapæ•°é‡è¾ƒå°æˆ–è€…æ¯”æœ¬èº«è‡ªåŠ¨åˆ†å‰²çš„å€¼è¿˜å°æ—¶å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç›¸å¯¹è¾ƒå¤§çš„é»˜è®¤å€¼ï¼Œä»è€Œæé«˜æ•´ä½“hadoopé›†ç¾¤çš„æ•ˆç‡ã€?'''
'''
def getMapNum(d,nodenum,avgmaptime):
    if avgmaptime < 1000:#å¦‚æœå°äº1åˆ†é’Ÿ
        return d['mapreduce.job.reduces']
    return nodenum*10
'''
'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?reduceä¸ªæ•°
@è¯´æ˜ï¼?reduceåœ¨è¿è¡Œæ—¶å¾€å¾€éœ€è¦ä»ç›¸å…³mapç«¯å¤åˆ¶æ•°æ®åˆ°reduceèŠ‚ç‚¹æ¥å¤„ç†ï¼Œå› æ­¤ç›¸æ¯”äºmapä»»åŠ¡ã€‚reduceèŠ‚ç‚¹èµ„æºæ˜¯ç›¸å¯¹æ¯”è¾ƒç¼ºå°‘çš„ï¼ŒåŒæ—¶ç›¸å¯¹è¿è¡Œè¾ƒæ…¢ï¼Œæ­£ç¡®çš„reduceä»»åŠ¡çš„ä¸ªæ•°åº”è¯¥æ˜¯0.95æˆ–è€?.75 *ï¼ˆèŠ‚ç‚¹æ•° Ã—mapred.tasktracker.tasks.maximumå‚æ•°å€¼ï¼‰ã€?å¦‚æœä»»åŠ¡æ•°æ˜¯èŠ‚ç‚¹ä¸ªæ•°çš?.95å€ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„reduceä»»åŠ¡èƒ½å¤Ÿåœ?mapä»»åŠ¡çš„è¾“å‡ºä¼ è¾“ç»“æŸååŒæ—¶å¼€å§‹è¿è¡Œã€?å¦‚æœä»»åŠ¡æ•°æ˜¯èŠ‚ç‚¹ä¸ªæ•°çš?.75å€ï¼Œé‚£ä¹ˆé«˜é€Ÿçš„èŠ‚ç‚¹ä¼šåœ¨å®Œæˆä»–ä»¬ç¬¬ä¸€æ‰¹reduceä»»åŠ¡è®¡ç®—ä¹‹åå¼€å§‹è®¡ç®—ç¬¬äºŒæ‰¹ reduceä»»åŠ¡ï¼Œè¿™æ ·çš„æƒ…å†µæ›´æœ‰åˆ©äºè´Ÿè½½å‡è¡¡ã€?åŒæ—¶éœ€è¦æ³¨æ„å¢åŠ reduceçš„æ•°é‡è™½ç„¶ä¼šå¢åŠ ç³»ç»Ÿçš„èµ„æºå¼€é”€ï¼Œä½†æ˜¯å¯ä»¥æ”¹å–„è´Ÿè½½åŒ€è¡¡ï¼Œé™ä½ä»»åŠ¡å¤±è´¥å¸¦æ¥çš„è´Ÿé¢å½±å“ã€?'''

def getReduceNum(d, nodenum):
    return int(int(d['mapreduce.tasktracker.reduce.tasks.maximum']) * 0.95 * nodenum)

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?mapred.reduce.parallel.copies
@è¯´æ˜ï¼?Reduce copyæ•°æ®çš„çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤å€¼æ˜¯5
Reduceåˆ°æ¯ä¸ªå®Œæˆçš„Map Task æ‹·è´æ•°æ®ï¼ˆé€šè¿‡RPCè°ƒç”¨ï¼‰ï¼Œé»˜è®¤åŒæ—¶å¯åŠ¨5ä¸ªçº¿ç¨‹åˆ°mapèŠ‚ç‚¹å–æ•°æ®ã€?è¿™ä¸ªé…ç½®è¿˜æ˜¯å¾ˆå…³é”®çš„ï¼Œå¦‚æœä½ çš„mapè¾“å‡ºæ•°æ®å¾ˆå¤§ï¼Œæœ‰æ—¶å€™ä¼šå‘ç°mapæ—©å°±100%äº†ï¼Œreduceå´åœ¨ç¼“æ…¢çš„å˜åŒ–ï¼Œé‚£å°±æ˜¯copyæ•°æ®å¤ªæ…¢äº†ï¼Œ
æ¯”å¦‚5ä¸ªçº¿ç¨‹copy 10Gçš„æ•°æ®ï¼Œç¡®å®ä¼šå¾ˆæ…¢ï¼Œè¿™æ—¶å°±è¦è°ƒæ•´è¿™ä¸ªå‚æ•°ï¼Œä½†æ˜¯è°ƒæ•´çš„å¤ªå¤§ï¼Œå®¹æ˜“é€ æˆé›†ç¾¤æ‹¥å µ
'''
def getReduceParallelCopies(mapOutputBytes, d, threshold=10000000):
    if mapOutputBytes > threshold:
        return int(float(d['mapreduce.task.io.sort.factor'] )* 1.5)
    else:
        return d['mapreduce.task.io.sort.factor']

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?mapred.job.shuffle.input.buffer.percent(0.7)
@è¯´æ˜ï¼?å½“æŒ‡å®šäº†JVMçš„å †å†…å­˜æœ€å¤§å€¼ä»¥åï¼Œä¸Šé¢è¿™ä¸ªé…ç½®é¡¹å°±æ˜¯Reduceç”¨æ¥å­˜æ”¾ä»MapèŠ‚ç‚¹å–è¿‡æ¥çš„æ•°æ®æ‰€ç”¨çš„å†…å­˜å å †å†…å­˜çš„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜?.7ï¼Œæ—¢70%ï¼Œé€šå¸¸è¿™ä¸ªæ¯”ä¾‹æ˜¯å¤Ÿäº†ï¼Œ
ä½†æ˜¯å¯¹äºå¤§æ•°æ®çš„æƒ…å†µï¼Œè¿™ä¸ªæ¯”ä¾‹è¿˜æ˜¯å°äº†ä¸€äº›ï¼Œ0.8-0.9ä¹‹é—´æ¯”è¾ƒåˆé€‚ã€?'''
import random
def getShuffleInputBufferPercent(reduceInRecord, d, threshold=1000000):
    if reduceInRecord > threshold:
        return random.randrange(73, 90, 2)*0.01
    else:
        return d['mapreduce.reduce.shuffle.input.buffer.percent']

'''
@è°ƒèŠ‚å‚æ•°åç§°ï¼?mapred.job.shuffle.merge.percent(é»˜è®¤å€?.66)
@è¯´æ˜ï¼?æŒ‡çš„æ˜¯ä»MapèŠ‚ç‚¹å–æ•°æ®è¿‡æ¥ï¼Œæ”¾åˆ°å†…å­˜ï¼Œå½“è¾¾åˆ°è¿™ä¸ªé˜ˆå€¼ä¹‹åï¼Œåå°å¯åŠ¨çº¿ç¨‹ï¼ˆé€šå¸¸æ˜¯Linux native processï¼‰æŠŠå†…å­˜ä¸­çš„æ•°æ®merge sortï¼Œå†™åˆ°reduceèŠ‚ç‚¹çš„æœ¬åœ°ç£ç›˜ï¼›
ä»å®é™…ç»éªŒæ¥çœ‹ï¼Œmapred.job.shuffle.merge.percenté»˜è®¤å€¼åå°ï¼Œå®Œå…¨å¯ä»¥è®¾ç½®åˆ?.8å·¦å³
'''
def getShuffleMergerPercent():
    return random.randrange(67, 82, 2)*0.01


